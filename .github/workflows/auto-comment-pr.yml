# .github/workflows/auto-comment-pr.yml

# Nome do Workflow: Este nome aparecer√° na aba "Actions" do seu reposit√≥rio GitHub.
name: Auto Comment on New PR

# Gatilho (Trigger): Define quando este workflow ser√° executado.
on:
  # Evento: pull_request
  pull_request:
    # Tipos: Especifica que o workflow deve rodar apenas quando uma PR for 'opened' (aberta).
    # Outros tipos comuns incluem 'reopened', 'synchronize' (quando novos commits s√£o adicionados), 'closed'.
    types: [opened, synchronize]

# Trabalhos (Jobs): Define uma ou mais tarefas que o workflow executar√°.
jobs:
  # Nome do Job: Um nome descritivo para o trabalho.
  add-comment:
    # Runner: Especifica o tipo de m√°quina virtual que executar√° o job.
    # 'ubuntu-latest' √© uma escolha comum e geralmente a mais atualizada.
    runs-on: ubuntu-latest

    # Passos (Steps): Sequ√™ncia de tarefas que comp√µem o job.
    steps:
      # Passo 1: Atualizar o corpo da Pull Request.
      - name: Update PR Body with Commit List
        # A√ß√£o utilizada: actions/github-script@v7
        # Esta a√ß√£o permite executar scripts que podem interagir com a API do GitHub.
        uses: actions/github-script@v7
        with:
          # Token do GitHub: Necess√°rio para autenticar e autorizar a action a interagir com seu reposit√≥rio.
          github-token: ${{ secrets.GITHUB_TOKEN }}
          # Script: O c√≥digo JavaScript que ser√° executado.
          script: |
            const emojiMap = {
              'feat:': '‚ú®',
              'fix:': 'üêõ',
              'docs:': 'üìù',
              'style:': 'üíÖ',
              'refactor:': '‚ôªÔ∏è',
              'test:': '‚úÖ',
              'perf:': 'üöÄ',
              'chore:': 'üîß',
              'ci:': '‚öôÔ∏è',
              'build:': 'üß±',
              'revert:': '‚è™',
              'sync:': 'üîÑ' // Adicionado para merge commits
            };

            const { data: commits } = await github.rest.pulls.listCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });

            let commitDetails = "Nenhum commit encontrado.";
            if (commits && commits.length > 0) {
              commitDetails = commits.map(commitData => {
                const fullMessage = commitData.commit.message.split('\n')[0]; // Pega apenas a primeira linha
                const commitUrl = commitData.html_url; // URL do commit
                let formattedMessage = ''; 
                let prefixMatched = false;

                // Verificar primeiro se √© um commit de merge
                if (fullMessage.toLowerCase().startsWith('merge branch')) {
                  formattedMessage = `${emojiMap['sync:']} **sync:** [${fullMessage}](${commitUrl})`;
                  prefixMatched = true; // Consideramos como um prefixo correspondido para pular o loop abaixo
                } else {
                  // Se n√£o for merge, procurar por outros prefixos sem√¢nticos
                  for (const prefix in emojiMap) {
                    // Ignorar 'sync:' aqui, pois j√° foi tratado
                    if (prefix === 'sync:') continue; 
                    
                    if (fullMessage.toLowerCase().startsWith(prefix)) {
                      const messageBody = fullMessage.substring(prefix.length).trim();
                      formattedMessage = `${emojiMap[prefix]} **${prefix}** [${messageBody}](${commitUrl})`;
                      prefixMatched = true;
                      break;
                    }
                  }
                }

                if (!prefixMatched) {
                  // Fallback para commits sem sem√¢ntica conhecida e que n√£o s√£o merge
                  formattedMessage = `üìÑ **misc:** [${fullMessage}](${commitUrl})`;
                }
                
                return formattedMessage;
              }).join('\n');
            }

            const descriptionSection = `
            ### Descri√ß√£o

            ${commitDetails}
            `;

            const checklistContent = `

            ---

            #### üìå Lembretes:
            - [ ] Conferir branch de destino.
            - [ ] Adicionar labels (se aplic√°vel).
            - [ ] Atualizar documenta√ß√£o (se aplic√°vel).
            `;

            const finalPrBody = descriptionSection + checklistContent;

            await github.rest.pulls.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              body: finalPrBody
            });
            console.log(`Corpo da PR #${context.issue.number} atualizado com a lista de commits e checklist.`);